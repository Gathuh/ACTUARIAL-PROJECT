---
title: "RESEARCH PROJECT"
author: "GATHU MACHARIA"
date: "2024-05-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r libraries}
```

```{r}
setwd("Data")

##############
library(dplyr)
###############


csv_files <- list.files(pattern = "*.csv")
data_list <- lapply(csv_files, read.csv)
# Extract company name from file names
company_names <- gsub("^HistoricalPrices \\(5\\)", "", gsub(".csv", "", csv_files))

# Add company column to each dataframe in the list
for (i in seq_along(data_list)) {
  data_list[[i]]$company <- company_names[i]
}
data_list <- lapply(data_list, function(df) {
  df$Date <- as.Date(df$Date,format="%m/%d/%y")
  return(df)
})


data_list_logreturn <- lapply(data_list, function(df) {
  df %>% 
    arrange(Date) %>% 
    mutate(Log_Return = c( diff(log(Close)),NA))%>%.[-nrow(.),]%>%.[, c(1,5,7,8)]%>%
    filter(Date<"2010-12-31" & Date>"2008-01-01")
})



#######################################################################
Date_manipulate <- function(df) {
  index <- which(df$Log_Return <= 0.05)[1]
  
  if (is.na(index)) {
    Datedown <- NA
  } else {
    Datedown <- df$Date[index]
  }
  
  index2 <- which(df$Log_Return >= 0.05 & df$Date > Datedown)[1]
  
  if (is.na(index2)) {
    Datedup <- NA
  } else {
    Datedup <- df$Date[index2]
  }
  Duration=Datedup-Datedown
  return(list(Datedown = Datedown, Datedup = Datedup,Duration=Duration))
 
}







##
x_down <- function(Log_Return, Date, threshold) {
  index <- which(Log_Return <= threshold)[1]
  if (!is.na(index)) {
    return(Date[index])
  } else {
    return(NA)
  }
}

x_up <- function(Log_Return, Date, threshold, down_index) {
  if (is.na(down_index)) {
    return(NA)
  } else {
    index <- which(Log_Return >= threshold & seq_along(Log_Return) > down_index)[1]
    if (!is.na(index)) {
      return(Date[index])
    } else {
      return(NA)
    }
  }
}

############################################################################
data_list_logreturn_x <- lapply(data_list_logreturn, function(df) {
  df %>%
    mutate(Date_down = x_down(Log_Return, Date, -0.05),
           Date_up = x_up(Log_Return, Date, 0.05, which(Log_Return <= -0.05)[1]))%>%
    mutate(Duration=Date_up-Date_down)
})
data_df_up <- do.call(rbind, lapply(data_list_logreturn_x, function(df1) {
  last_date <- tail(df1$Date, 1)
  filtered_df <- dplyr::filter(df1, Date == Date_up)
  return(filtered_df)
}))

```

In our data we want to include both inflation and exchange rates. We will include exchange rates by $merge()$ by `Date_up`. the reason for that is that we want to know by the date the market was rebounding uder what economic conditions was the company experiencing. To read this we don't need any special function we just do it with $read_csv()$.

```{r}
inflation=readr::read_csv("Data/Inflation rates/Inflation Rates.csv")
exchange_rate=readr::read_csv("Data/exchange rates/Key CBK Indicative Exchange Rates (1).csv")
inflation=inflation %>% mutate(Date=as.Date(paste0(Year,"-",Month,"-01"),format="%Y-%b-%d")) %>% mutate(year_month=paste0(lubridate::year(Date),"-",months(Date)) )
exchange_rate=exchange_rate %>% mutate(Date=as.Date(Date,format = "%d/%m/%d") )%>% mutate(year_month=paste0(lubridate::year(Date),"-",months(Date)) )
```

Merging the Data with the date that the stock prices of each company rebound to nomalcy

```{r}
data=data_df_up %>% mutate(year_month=paste0(lubridate::year(Date),"-",months(Date)) ) %>% 
  left_join(exchange_rate,by="year_month")

```

